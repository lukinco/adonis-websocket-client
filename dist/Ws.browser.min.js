!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.adonis=e.adonis||{},e.adonis.Ws=t())}(this,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(i,o){try{var a=t[i](o),c=a.value}catch(e){return void n(e)}if(!a.done)return Promise.resolve(c).then(function(e){r("next",e)},function(e){r("throw",e)});e(c)}("next")})}},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},c=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&c.return&&c.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},s=new WeakMap,f=new WeakMap,l=Promise.resolve();function p(e){if("string"!=typeof e)throw new TypeError("eventName must be a string")}function h(e){if("function"!=typeof e)throw new TypeError("listener must be a function")}function v(e,t){var n=f.get(e);return n.has(t)||n.set(t,new Set),n.get(t)}var y=function(){function e(){n(this,e),s.set(this,new Set),f.set(this,new Map)}return r(e,[{key:"on",value:function(e,t){return p(e),h(t),v(this,e).add(t),this.off.bind(this,e,t)}},{key:"off",value:function(e,t){p(e),h(t),v(this,e).delete(t)}},{key:"once",value:function(e){var t=this;return new Promise(function(n){p(e);var r=t.on(e,function(e){r(),n(e)})})}},{key:"emit",value:function(){var e=t(regeneratorRuntime.mark(function e(n,r){var i,o,a,c,f=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p(n),i=v(this,n),o=s.get(this),a=[].concat(u(i)),c=[].concat(u(o)),e.next=7,l;case 7:return e.abrupt("return",Promise.all([].concat(u(a.map(function(){var e=t(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.has(t)){e.next=2;break}return e.abrupt("return",t(r));case 2:case"end":return e.stop()}},e,f)}));return function(t){return e.apply(this,arguments)}}())),u(c.map(function(){var e=t(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o.has(t)){e.next=2;break}return e.abrupt("return",t(n,r));case 2:case"end":return e.stop()}},e,f)}));return function(t){return e.apply(this,arguments)}}())))));case 8:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"emitSerial",value:function(){var e=t(regeneratorRuntime.mark(function e(t,n){var r,i,o,a,c,f,h,y,d,m,k,b,g,w,_,E;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return p(t),r=v(this,t),i=s.get(this),o=[].concat(u(r)),a=[].concat(u(i)),e.next=7,l;case 7:c=!0,f=!1,h=void 0,e.prev=10,y=o[Symbol.iterator]();case 12:if(c=(d=y.next()).done){e.next=20;break}if(m=d.value,!r.has(m)){e.next=17;break}return e.next=17,m(n);case 17:c=!0,e.next=12;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(10),f=!0,h=e.t0;case 26:e.prev=26,e.prev=27,!c&&y.return&&y.return();case 29:if(e.prev=29,!f){e.next=32;break}throw h;case 32:return e.finish(29);case 33:return e.finish(26);case 34:k=!0,b=!1,g=void 0,e.prev=37,w=a[Symbol.iterator]();case 39:if(k=(_=w.next()).done){e.next=47;break}if(E=_.value,!i.has(E)){e.next=44;break}return e.next=44,E(t,n);case 44:k=!0,e.next=39;break;case 47:e.next=53;break;case 49:e.prev=49,e.t1=e.catch(37),b=!0,g=e.t1;case 53:e.prev=53,e.prev=54,!k&&w.return&&w.return();case 56:if(e.prev=56,!b){e.next=59;break}throw g;case 59:return e.finish(56);case 60:return e.finish(53);case 61:case"end":return e.stop()}},e,this,[[10,22,26,34],[27,,29,33],[37,49,53,61],[54,,56,60]])}));return function(t,n){return e.apply(this,arguments)}}()},{key:"onAny",value:function(e){return h(e),s.get(this).add(e),this.offAny.bind(this,e)}},{key:"offAny",value:function(e){h(e),s.get(this).delete(e)}},{key:"clearListeners",value:function(e){if("string"==typeof e)v(this,e).clear();else{s.get(this).clear();var t=!0,n=!1,r=void 0;try{for(var i,o=f.get(this).values()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){i.value.clear()}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}}},{key:"listenerCount",value:function(e){if("string"==typeof e)return s.get(this).size+v(this,e).size;void 0!==e&&p(e);var t=s.get(this).size,n=!0,r=!1,i=void 0;try{for(var o,a=f.get(this).values()[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){t+=o.value.size}}catch(e){r=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return t}}]),e}();y.Typed=function(e){function t(){return n(this,t),a(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,y),t}(),Object.defineProperty(y.Typed,"Typed",{enumerable:!1,value:void 0});var d=y;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function m(e,t){return e(t={exports:{}},t.exports),t.exports}var k=function(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})},b=new RegExp("%[a-f0-9]{2}","gi"),g=new RegExp("(%[a-f0-9]{2})+","gi");function w(e,t){try{return decodeURIComponent(e.join(""))}catch(e){}if(1===e.length)return e;t=t||1;var n=e.slice(0,t),r=e.slice(t);return Array.prototype.concat.call([],w(n),w(r))}function _(e){try{return decodeURIComponent(e)}catch(r){for(var t=e.match(b),n=1;n<t.length;n++)t=(e=w(t,n).join("")).match(b);return e}}var E=function(t){if("string"!=typeof t)throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+(void 0===t?"undefined":e(t))+"`");try{return t=t.replace(/\+/g," "),decodeURIComponent(t)}catch(e){return function(e){for(var t={"%FE%FF":"��","%FF%FE":"��"},n=g.exec(e);n;){try{t[n[0]]=decodeURIComponent(n[0])}catch(e){var r=_(n[0]);r!==n[0]&&(t[n[0]]=r)}n=g.exec(e)}t["%C2"]="�";for(var i=Object.keys(t),o=0;o<i.length;o++){var a=i[o];e=e.replace(new RegExp(a,"g"),t[a])}return e}(t)}},S=function(e,t){if("string"!=typeof e||"string"!=typeof t)throw new TypeError("Expected the arguments to be of type `string`");if(""===t)return[e];var n=e.indexOf(t);return-1===n?[e]:[e.slice(0,n),e.slice(n+t.length)]},x=m(function(t,n){function r(e){if("string"!=typeof e||1!==e.length)throw new TypeError("arrayFormatSeparator must be single character string")}function o(e,t){return t.encode?t.strict?k(e):encodeURIComponent(e):e}function a(e,t){return t.decode?E(e):e}function s(e){var t=e.indexOf("#");return-1!==t&&(e=e.slice(0,t)),e}function f(e){var t=(e=s(e)).indexOf("?");return-1===t?"":e.slice(t+1)}function l(e,t){return t.parseNumbers&&!Number.isNaN(Number(e))&&"string"==typeof e&&""!==e.trim()?e=Number(e):!t.parseBooleans||null===e||"true"!==e.toLowerCase()&&"false"!==e.toLowerCase()||(e="true"===e.toLowerCase()),e}function p(t,n){r((n=i({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},n)).arrayFormatSeparator);var o=function(e){var t=void 0;switch(e.arrayFormat){case"index":return function(e,n,r){t=/\[(\d*)\]$/.exec(e),e=e.replace(/\[\d*\]$/,""),t?(void 0===r[e]&&(r[e]={}),r[e][t[1]]=n):r[e]=n};case"bracket":return function(e,n,r){t=/(\[\])$/.exec(e),e=e.replace(/\[\]$/,""),t?void 0!==r[e]?r[e]=[].concat(r[e],n):r[e]=[n]:r[e]=n};case"comma":case"separator":return function(t,n,r){var i="string"==typeof n&&n.includes(e.arrayFormatSeparator),o="string"==typeof n&&!i&&a(n,e).includes(e.arrayFormatSeparator);n=o?a(n,e):n;var c=i||o?n.split(e.arrayFormatSeparator).map(function(t){return a(t,e)}):null===n?n:a(n,e);r[t]=c};default:return function(e,t,n){void 0!==n[e]?n[e]=[].concat(n[e],t):n[e]=t}}}(n),u=Object.create(null);if("string"!=typeof t)return u;if(!(t=t.trim().replace(/^[?#&]/,"")))return u;var s=!0,f=!1,p=void 0;try{for(var h,v=t.split("&")[Symbol.iterator]();!(s=(h=v.next()).done);s=!0){var y=h.value,d=S(n.decode?y.replace(/\+/g," "):y,"="),m=c(d,2),k=m[0];x=void 0===(x=m[1])?null:["comma","separator"].includes(n.arrayFormat)?x:a(x,n),o(a(k,n),x,u)}}catch(e){f=!0,p=e}finally{try{!s&&v.return&&v.return()}finally{if(f)throw p}}var b=!0,g=!1,w=void 0;try{for(var _,E=Object.keys(u)[Symbol.iterator]();!(b=(_=E.next()).done);b=!0){var x;k=_.value;if("object"===(void 0===(x=u[k])?"undefined":e(x))&&null!==x){var O=!0,P=!1,A=void 0;try{for(var j,R=Object.keys(x)[Symbol.iterator]();!(O=(j=R.next()).done);O=!0){var N=j.value;x[N]=l(x[N],n)}}catch(e){P=!0,A=e}finally{try{!O&&R.return&&R.return()}finally{if(P)throw A}}}else u[k]=l(x,n)}}catch(e){g=!0,w=e}finally{try{!b&&E.return&&E.return()}finally{if(g)throw w}}return!1===n.sort?u:(!0===n.sort?Object.keys(u).sort():Object.keys(u).sort(n.sort)).reduce(function(t,n){var r=u[n];return Boolean(r)&&"object"===(void 0===r?"undefined":e(r))&&!Array.isArray(r)?t[n]=function t(n){return Array.isArray(n)?n.sort():"object"===(void 0===n?"undefined":e(n))?t(Object.keys(n)).sort(function(e,t){return Number(e)-Number(t)}).map(function(e){return n[e]}):n}(r):t[n]=r,t},Object.create(null))}n.extract=f,n.parse=p,n.stringify=function(e,t){if(!e)return"";r((t=i({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},t)).arrayFormatSeparator);var n=function(n){return t.skipNull&&(null===(r=e[n])||void 0===r)||t.skipEmptyString&&""===e[n];var r},a=function(e){switch(e.arrayFormat){case"index":return function(t){return function(n,r){var i=n.length;return void 0===r||e.skipNull&&null===r||e.skipEmptyString&&""===r?n:[].concat(u(n),null===r?[[o(t,e),"[",i,"]"].join("")]:[[o(t,e),"[",o(i,e),"]=",o(r,e)].join("")])}};case"bracket":return function(t){return function(n,r){return void 0===r||e.skipNull&&null===r||e.skipEmptyString&&""===r?n:[].concat(u(n),null===r?[[o(t,e),"[]"].join("")]:[[o(t,e),"[]=",o(r,e)].join("")])}};case"comma":case"separator":return function(t){return function(n,r){return null===r||void 0===r||0===r.length?n:0===n.length?[[o(t,e),"=",o(r,e)].join("")]:[[n,o(r,e)].join(e.arrayFormatSeparator)]}};default:return function(t){return function(n,r){return void 0===r||e.skipNull&&null===r||e.skipEmptyString&&""===r?n:[].concat(u(n),null===r?[o(t,e)]:[[o(t,e),"=",o(r,e)].join("")])}}}}(t),c={},s=!0,f=!1,l=void 0;try{for(var p,h=Object.keys(e)[Symbol.iterator]();!(s=(p=h.next()).done);s=!0){var v=p.value;n(v)||(c[v]=e[v])}}catch(e){f=!0,l=e}finally{try{!s&&h.return&&h.return()}finally{if(f)throw l}}var y=Object.keys(c);return!1!==t.sort&&y.sort(t.sort),y.map(function(n){var r=e[n];return void 0===r?"":null===r?o(n,t):Array.isArray(r)?r.reduce(a(n),[]).join("&"):o(n,t)+"="+o(r,t)}).filter(function(e){return e.length>0}).join("&")},n.parseUrl=function(e,t){t=i({decode:!0},t);var n=S(e,"#"),r=c(n,2),o=r[0],u=r[1];return i({url:o.split("?")[0]||"",query:p(f(e),t)},t&&t.parseFragmentIdentifier&&u?{fragmentIdentifier:a(u,t)}:{})},n.stringifyUrl=function(e,t){t=i({encode:!0,strict:!0},t);var r=s(e.url).split("?")[0]||"",a=n.extract(e.url),c=n.parse(a,{sort:!1}),u=i(c,e.query),f=n.stringify(u,t);f&&(f="?"+f);var l=function(e){var t="",n=e.indexOf("#");return-1!==n&&(t=e.slice(n)),t}(e.url);return e.fragmentIdentifier&&(l="#"+o(e.fragmentIdentifier,t)),""+r+f+l}}),O=(x.extract,x.parse,x.stringify),P=(x.parseUrl,x.stringifyUrl,m(function(t,n){t.exports=function(){var t="function"==typeof Symbol&&"symbol"==e(Symbol.iterator)?function(t){return void 0===t?"undefined":e(t)}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":void 0===t?"undefined":e(t)},n={OPEN:0,JOIN:1,LEAVE:2,JOIN_ACK:3,JOIN_ERROR:4,LEAVE_ACK:5,LEAVE_ERROR:6,EVENT:7,PING:8,PONG:9};function r(e,t,n){return n.forEach(function(e){!function(e,t){if(!e||"string"!=typeof e)throw new Error(t)}(t[e],"expected "+e+" to be a valid string")}),{t:e,d:t}}var o={};return Object.keys(n).forEach(function(e){var r=e.toLowerCase().replace(/^\w|_(\w)/g,function(e,t){return t?t.toUpperCase():e.toUpperCase()});o["is"+r+"Packet"]=function(r){return!(!r||"object"!==(void 0===r?"undefined":t(r))||r.t!==n[e])}}),o.hasTopic=function(e){return!!(e&&e.d&&e.d.topic)},o.isValidJoinPacket=o.hasTopic,o.isValidLeavePacket=o.hasTopic,o.isValidEventPacket=o.hasTopic,o.joinPacket=function(e){return r(n.JOIN,{topic:e},["topic"])},o.leavePacket=function(e){return r(n.LEAVE,{topic:e},["topic"])},o.joinAckPacket=function(e){return r(n.JOIN_ACK,{topic:e},["topic"])},o.joinErrorPacket=function(e,t){return r(n.JOIN_ERROR,{topic:e,message:t},["topic","message"])},o.leaveAckPacket=function(e){return r(n.LEAVE_ACK,{topic:e},["topic"])},o.leaveErrorPacket=function(e,t){return r(n.LEAVE_ERROR,{topic:e,message:t},["topic","message"])},o.eventPacket=function(e,t,i){return r(n.EVENT,{topic:e,event:t,data:i=i||""},["topic","event"])},o.pingPacket=function(){return{t:n.PING}},o.pongPacket=function(){return{t:n.PONG}},i({codes:n},o)}()})),A=(m(function(e){e.exports=function(){}}),function(){function e(t,r){n(this,e),this.topic=t,this.connection=r,this.emitter=new d,this._state="pending",this._emitBuffer=[]}return r(e,[{key:"joinAck",value:function(){var e=this;this.state="open",this.emitter.emit("ready",this),this._emitBuffer.forEach(function(t){return e.emit(t.event,t.data)}),this._emitBuffer=[]}},{key:"joinError",value:function(e){this.state="error",this.emitter.emit("error",e),this.serverClose()}},{key:"leaveAck",value:function(){this.state="closed",this.serverClose()}},{key:"leaveError",value:function(e){this.emitter.emit("leaveError",e)}},{key:"on",value:function(){var e;(e=this.emitter).on.apply(e,arguments)}},{key:"once",value:function(){var e;(e=this.emitter).once.apply(e,arguments)}},{key:"off",value:function(){var e;(e=this.emitter).off.apply(e,arguments)}},{key:"emit",value:function(e,t){"pending"!==this.state?this.connection.sendEvent(this.topic,e,t):this._emitBuffer.push({event:e,data:t})}},{key:"serverClose",value:function(){var e=this;return this.emitter.emit("close",this).then(function(){e._emitBuffer=[],e.emitter.clearListeners()}).catch(function(){e._emitBuffer=[],e.emitter.clearListeners()})}},{key:"serverEvent",value:function(e){var t=e.event,n=e.data;this.emitter.emit(t,n)}},{key:"serverError",value:function(){this.state="error"}},{key:"close",value:function(){this.state="closing",this.connection.sendPacket(P.leavePacket(this.topic))}},{key:"terminate",value:function(){this.leaveAck()}},{key:"state",get:function(){return this._state},set:function(e){if(-1===!this.constructor.states.indexOf(e))throw new Error(e+" is not a valid socket state");this._state=e}}],[{key:"states",get:function(){return["pending","open","closed","closing","error"]}}]),e}()),j={name:"json",encode:function(e,t){var n=null;try{n=JSON.stringify(e)}catch(e){return t(e)}t(null,n)},decode:function(e,t){var n=null;try{n=JSON.parse(e)}catch(e){return t(e)}t(null,n)}},R=function(e){function t(e,r){n(this,t);var o=a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e=e||o.getWsUrl(),o.options=i({path:"adonis-ws",reconnection:!0,reconnectionAttempts:10,reconnectionDelay:1e3,query:null,encoder:j},r),o._connectionState="idle",o._reconnectionAttempts=0,o._packetsQueue=[],o._processingQueue=!1,o._pingTimer=null,o._extendedQuery={},o._url=e.replace(/\/$/,"")+"/"+o.options.path,o.subscriptions={},o.removeSubscription=function(e){var t=e.topic;delete o.subscriptions[t]},o}return o(t,d),r(t,[{key:"getWsUrl",value:function(){return("undefined"!=typeof window&&"https:"===window.location.protocol?"wss":"ws")+"://"+window.location.host}},{key:"_cleanup",value:function(){clearInterval(this._pingTimer),this.ws=null,this._pingTimer=null}},{key:"_subscriptionsIterator",value:function(e){var t=this;Object.keys(this.subscriptions).forEach(function(n){return e(t.subscriptions[n],n)})}},{key:"_ensureSubscription",value:function(e,t){var n=this.getSubscription(e.d.topic);n&&t(n,e)}},{key:"_processQueue",value:function(){var e=this;!this._processingQueue&&this._packetsQueue.length&&(this._processingQueue=!0,this.options.encoder.encode(this._packetsQueue.shift(),function(t,n){t||(e.write(n),e._processingQueue=!1,e._processQueue())}))}},{key:"_onOpen",value:function(){}},{key:"_onError",value:function(e){this._subscriptionsIterator(function(e){return e.serverError()}),this.emit("error",e)}},{key:"_reconnect",value:function(){var e=this;this._reconnectionAttempts++,this.emit("reconnect",this._reconnectionAttempts),setTimeout(function(){e._connectionState="reconnect",e.connect()},this.options.reconnectionDelay*this._reconnectionAttempts)}},{key:"_onClose",value:function(e){var t=this;this._cleanup(),this._subscriptionsIterator(function(e){return e.terminate()}),this.emit("close",this).then(function(){t.shouldReconnect?t._reconnect():t.clearListeners()}).catch(function(){t.shouldReconnect?t._reconnect():t.clearListeners()})}},{key:"_onMessage",value:function(e){var t=this;this.options.encoder.decode(e.data,function(e,n){e||t._handleMessage(n)})}},{key:"_handleMessage",value:function(e){P.isOpenPacket(e)?this._handleOpen(e):P.isJoinAckPacket(e)?this._handleJoinAck(e):P.isJoinErrorPacket(e)?this._handleJoinError(e):P.isLeaveAckPacket(e)?this._handleLeaveAck(e):P.isLeaveErrorPacket(e)?this._handleLeaveError(e):P.isLeavePacket(e)?this._handleServerLeave(e):P.isEventPacket(e)?this._handleEvent(e):P.isPongPacket(e)}},{key:"_handleOpen",value:function(e){var t=this;this._connectionState="open",this.emit("open",e.d),this._pingTimer=setInterval(function(){t.sendPacket(P.pingPacket())},e.d.clientInterval),this._subscriptionsIterator(function(e){t._sendSubscriptionPacket(e.topic)})}},{key:"_handleJoinAck",value:function(e){this._ensureSubscription(e,function(e){return e.joinAck()})}},{key:"_handleJoinError",value:function(e){this._ensureSubscription(e,function(e,t){return e.joinError(t.d)})}},{key:"_handleLeaveAck",value:function(e){this._ensureSubscription(e,function(e){return e.leaveAck()})}},{key:"_handleLeaveError",value:function(e){this._ensureSubscription(e,function(e,t){return e.leaveError(t.d)})}},{key:"_handleServerLeave",value:function(e){this._ensureSubscription(e,function(e,t){return e.leaveAck()})}},{key:"_handleEvent",value:function(e){this._ensureSubscription(e,function(e,t){return e.serverEvent(t.d)})}},{key:"_sendSubscriptionPacket",value:function(e){this.sendPacket(P.joinPacket(e))}},{key:"connect",value:function(){var e=this,t=O(i({},this.options.query,this._extendedQuery)),n=t?this._url+"?"+t:this._url;return this.ws=new window.WebSocket(n),this.ws.onclose=function(t){return e._onClose(t)},this.ws.onerror=function(t){return e._onError(t)},this.ws.onopen=function(t){return e._onOpen(t)},this.ws.onmessage=function(t){return e._onMessage(t)},this}},{key:"write",value:function(e){this.ws.readyState===window.WebSocket.OPEN&&this.ws.send(e)}},{key:"sendPacket",value:function(e){this._packetsQueue.push(e),this._processQueue()}},{key:"getSubscription",value:function(e){return this.subscriptions[e]}},{key:"hasSubcription",value:function(e){return!!this.getSubscription(e)}},{key:"subscribe",value:function(e){if(!e||"string"!=typeof e)throw new Error("subscribe method expects topic to be a valid string");if(this.subscriptions[e])throw new Error("Cannot subscribe to same topic twice. Instead use getSubscription");var t=new A(e,this);return t.on("close",this.removeSubscription),this.subscriptions[e]=t,"open"===this._connectionState&&this._sendSubscriptionPacket(e),t}},{key:"sendEvent",value:function(e,t,n){if(!e||!t)throw new Error("topic and event name is required to call sendEvent method");var r=this.getSubscription(e);if(!r)throw new Error("There is no active subscription for "+e+" topic");if("open"!==r.state)throw new Error("Cannot emit since subscription socket is in "+this.state+" state");this.sendPacket(P.eventPacket(e,t,n))}},{key:"withJwtToken",value:function(e){return this._extendedQuery.token=e,this}},{key:"withBasicAuth",value:function(e,t){return this._extendedQuery.basic=window.btoa(e+":"+t),this}},{key:"withApiToken",value:function(e){return this._extendedQuery.token=e,this}},{key:"close",value:function(){this._connectionState="terminated",this.ws.close()}},{key:"shouldReconnect",get:function(){return"terminated"!==this._connectionState&&this.options.reconnection&&this.options.reconnectionAttempts>this._reconnectionAttempts}}]),t}();return function(e,t){return new R(e,t)}});
